#include "flash.h"

/*
const uint8_t nvm_t_data[60] __attribute__((at(0x08007800))) 
={
	0x10,0x00,0x01,0x00,0x48,0x01,0x01,0x00,0x00,0x00,0x01,0x00,0x20,0x03,0x90,0x01,
	0x01,0x00,0xc8,0x00,0x01,0x00,0x00,0x00,0x9A,0x99,0x19,0x3F,0x6F,0x12,0x83,0x3A,
	0x6F,0x12,0x83,0x3A,0x00,0x00,0x80,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x40,0x00,0x00,0x80,0x3F,0x00,0x00,0x80,0x3F,
};
*/
const uint16_t nvm_t_data[30] //__attribute__((at(0x08007800))) 
={
	0x0010,0x0001,0x0148,0x0001,0x0000,0x0001,0x0320,0x0190,
	0x0001,0x00c8,0x0001,0x0000,0x999A,0x3F19,0x126F,0x3A83,
	0x126F,0x3A83,0x0000,0x3F80,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x4000,0x0000,0x3F80,0x0000,0x3F80,
};
const uint16_t flash_calTable[259] //
={	
#if 1
0x5DF0,0x5E73,0x5EF8,0x5F73,0x5FF4,0x6077,0x60F5,0x6179,0x61F3,0x6276,0x62F7,0x6373,0x63F5,0x6470,0x64F2,0x6574,
0x65EE,0x6670,0x66EA,0x676A,0x67EA,0x6863,0x68E6,0x6964,0x69DF,0x6A60,0x6AD8,0x6B5B,0x6BDB,0x6C56,0x6CD4,0x6D4D,
0x6DD1,0x6E50,0x6EC6,0x6F44,0x6FC2,0x7043,0x70C4,0x713A,0x71BA,0x7238,0x72B8,0x7338,0x73B0,0x742F,0x74B0,0x752D,
0x75AE,0x7629,0x76A9,0x772A,0x77A4,0x7827,0x78A1,0x7923,0x79A6,0x7A1F,0x7AA4,0x7B1D,0x7BA1,0x7C22,0x7C9D,0x7D20,
0x7DA1,0x7E20,0x7EA6,0x7F20,0x7FA3,0x0026,0x00A4,0x0128,0x01A6,0x022A,0x02AE,0x032B,0x03B2,0x0432,0x04B6,0x0539,
0x05B7,0x063C,0x06BE,0x0744,0x07C8,0x0846,0x08CC,0x0951,0x09D4,0x0A5A,0x0AD4,0x0B5C,0x0BE5,0x0C64,0x0CEB,0x0D6B,
0x0DEE,0x0E77,0x0EF6,0x0F7B,0x0FFA,0x1083,0x1109,0x1187,0x120B,0x128B,0x1312,0x1396,0x1417,0x149D,0x151F,0x15A0,
0x1624,0x16A2,0x172A,0x17AE,0x182A,0x18AF,0x192C,0x19B3,0x1A38,0x1AB1,0x1B35,0x1BB4,0x1C39,0x1CBE,0x1D35,0x1DB8,
0x1E3A,0x1EBA,0x1F3E,0x1FB3,0x2039,0x20B9,0x2137,0x21B9,0x2231,0x22B2,0x2334,0x23AE,0x2431,0x24A9,0x252C,0x25AA,
0x2621,0x26A3,0x2720,0x279E,0x2820,0x2899,0x2916,0x2993,0x2A11,0x2A91,0x2B08,0x2B86,0x2C08,0x2C80,0x2CFE,0x2D77,
0x2DFA,0x2E79,0x2EEF,0x2F6D,0x2FE8,0x3069,0x30E8,0x315F,0x31DF,0x325A,0x32D9,0x335A,0x33D0,0x344F,0x34D1,0x354C,
0x35CF,0x3645,0x36C5,0x3746,0x37C3,0x3844,0x38BD,0x3940,0x39C2,0x3A3B,0x3ABD,0x3B3A,0x3BBC,0x3C3C,0x3CB6,0x3D3B,
0x3DBC,0x3E3A,0x3EBC,0x3F38,0x3FBA,0x403E,0x40BD,0x413C,0x41B9,0x423D,0x42C2,0x433E,0x43C4,0x443E,0x44C5,0x454D,
0x45C8,0x464A,0x46CD,0x4750,0x47D5,0x4850,0x48D5,0x4959,0x49DD,0x4A63,0x4ADD,0x4B60,0x4BE7,0x4C67,0x4CEB,0x4D68,
0x4DEC,0x4E74,0x4EF5,0x4F79,0x4FF7,0x507C,0x5101,0x517E,0x5205,0x5283,0x5305,0x538A,0x5408,0x548F,0x5511,0x5590,
0x5614,0x5690,0x5716,0x579A,0x5815,0x5897,0x5915,0x599A,0x5A20,0x5A97,0x5B18,0x5B99,0x5C1B,0x5CA0,0x5D16,0x5D98,
0x0001,0x0026,0x7FA3,
#else
0,128,256,384,512,640,768,896,1024,1152,1280,1408,1536,1664,1792,1920,
2048,2176,2304,2432,2560,2688,2816,2944,3072,3200,3328,3456,3584,3712,3840,3968,
4096,4224,4352,4480,4608,4736,4864,4992,5120,5248,5376,5504,5632,5760,5888,6016,
6144,6272,6400,6528,6656,6784,6912,7040,7168,7296,7424,7552,7680,7808,7936,8064,
8192,8320,8448,8576,8704,8832,8960,9088,9216,9344,9472,9600,9728,9856,9984,10112,
10240,10368,10496,10624,10752,10880,11008,11136,11264,11392,11520,11648,11776,11904,12032,12160,
12288,12416,12544,12672,12800,12928,13056,13184,13312,13440,13568,13696,13824,13952,14080,14208,
14336,14464,14592,14720,14848,14976,15104,15232,15360,15488,15616,15744,15872,16000,16128,16256,
16384,16512,16640,16768,16896,17024,17152,17280,17408,17536,17664,17792,17920,18048,18176,18304,
18432,18560,18688,18816,18944,19072,19200,19328,19456,19584,19712,19840,19968,20096,20224,20352,
20480,20608,20736,20864,20992,21120,21248,21376,21504,21632,21760,21888,22016,22144,22272,22400,
22528,22656,22784,22912,23040,23168,23296,23424,23552,23680,23808,23936,24064,24192,24320,24448,
24576,24704,24832,24960,25088,25216,25344,25472,25600,25728,25856,25984,26112,26240,26368,26496,
26624,26752,26880,27008,27136,27264,27392,27520,27648,27776,27904,28032,28160,28288,28416,28544,
28672,28800,28928,29056,29184,29312,29440,29568,29696,29824,29952,30080,30208,30336,30464,30592,
30720,30848,30976,31104,31232,31360,31488,31616,31744,31872,32000,32128,32256,32384,32512,32640,
0x0001,0,0x7F80,
#endif
};

//擦除该页，再写入一页以内的uint16_t数据
/*
 *	flashAddr:	页地址
 *	ptrData:		数据地址
 *	size:				待写入uint16_t长度(size<=512字节,size为偶数)
*/
void Flash_ProgramPage(uint32_t flashAddr, uint16_t* ptrData, uint16_t size)
{
	uint32_t i;
	
	FLASH_Unlock(); //解锁flash
	
	FLASH_ErasePage(flashAddr); //擦除该页
	
	for(i=0; i < size; i++) 			//写入该页
	{
		if(FLASH_WaitForLastOperation(FLASH_WAIT_TIMEOUT) != FLASH_COMPLETE)
		{
			FLASH_ClearFlag(FLASH_FLAG_EOP | FLASH_FLAG_PGERR | FLASH_FLAG_WRPRTERR);
		}
		FLASH_ProgramHalfWord(flashAddr, (*ptrData));
		flashAddr += 2;
		ptrData += 1;
	}
	
	FLASH_Lock(); //上锁写保护
}

//不擦除该页，直接写入一页以内的uint16_t数据
/*
 *	flashAddr:	写入地址
 *	ptrData:		数据地址
 *	size:				待写入uint16_t长度(size<=512字节,size为偶数)
*/
void Flash_ProgramSize(uint32_t flashAddr, uint16_t* ptrData, uint16_t size)
{
	uint32_t i;
	
	FLASH_Unlock(); 
	
	for(i=0; i<size; i++)
	{
		if(FLASH_WaitForLastOperation(FLASH_WAIT_TIMEOUT) != FLASH_COMPLETE)
		{
			FLASH_ClearFlag(FLASH_FLAG_EOP | FLASH_FLAG_PGERR | FLASH_FLAG_WRPRTERR);
		}	
		FLASH_ProgramHalfWord(flashAddr, (*ptrData));
		flashAddr += 2;
		ptrData += 1;
	}
	
	FLASH_Lock();
}

//读取一个uint16_t数据
uint16_t Flash_readHalfWord(uint32_t address)
{
  return (*(__IO uint16_t*)address); 
}

//读取一个uint32_t数据
uint32_t Flash_readWord(uint32_t address)
{
  return (*(__IO uint32_t*)address); 
}

//验证address后面的30个uint16_t是不是都为0xFFFF(可写入)
bool Flash_checknvmFlash(uint32_t address)
{
	uint32_t i;
	for(i=0; i < (sizeof(nvm_t)/2); i++)
	{
		if( Flash_readHalfWord( address + (i * 2) ) != invalid )
			return false;
	}
	return true;
}
